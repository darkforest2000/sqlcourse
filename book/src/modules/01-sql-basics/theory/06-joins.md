# 9.6. JOIN операции

Оператор `JOIN` — это сердце реляционных баз данных. Он используется в запросах `SELECT` для объединения строк из двух или более таблиц на основе связанных столбцов. Без `JOIN` нам пришлось бы делать множество отдельных запросов и объединять данные вручную на стороне приложения, что крайне неэффективно.

Для примеров будем использовать наши таблицы `employees` и `departments`.

**`departments`**
| id | name      |
|----|-----------|
| 1  | IT        |
| 2  | HR        |
| 3  | Marketing |

**`employees`**
| id | full_name       | department_id |
|----|-----------------|---------------|
| 1  | Иван Петров     | 1             |
| 2  | Мария Козлова   | 1             |
| 3  | Анна Иванова    | 2             |
| 4  | Сергей Безруков | NULL          | <!-- Сотрудник без отдела -->

## `INNER JOIN` (Внутреннее соединение)

Возвращает только те строки, для которых условие соединения выполняется в **обеих** таблицах. Это самый частый тип `JOIN`. Если в одной из таблиц нет совпадения, строка не попадает в результат.

**Задача:** Вывести список сотрудников и названия их отделов.

```sql
SELECT
    e.full_name,
    d.name
FROM
    employees AS e
INNER JOIN
    departments AS d ON e.department_id = d.id;
```

**Результат:**
| full_name       | name      |
|-----------------|-----------|
| Иван Петров     | IT        |
| Мария Козлова   | IT        |
| Анна Иванова    | HR        |

Обратите внимание: Сергей Безруков (без отдела) и отдел Marketing (без сотрудников) не попали в выборку.

*Диаграмма Венна: пересечение двух множеств.*
![INNER JOIN](https://i.imgur.com/39m2s2b.png)

## `LEFT JOIN` (Левое внешнее соединение)

Возвращает **все** строки из **левой** таблицы (первой, указанной в `FROM`) и совпадающие строки из правой таблицы. Если совпадения в правой таблице нет, то для её столбцов возвращается `NULL`.

**Задача:** Вывести **всех** сотрудников и, если возможно, названия их отделов.

```sql
SELECT
    e.full_name,
    d.name
FROM
    employees AS e
LEFT JOIN
    departments AS d ON e.department_id = d.id;
```

**Результат:**
| full_name       | name      |
|-----------------|-----------|
| Иван Петров     | IT        |
| Мария Козлова   | IT        |
| Анна Иванова    | HR        |
| Сергей Безруков | **NULL**  |

Теперь в результате есть все сотрудники, включая тех, у кого нет отдела.

*Диаграмма Венна: все левое множество.*
![LEFT JOIN](https://i.imgur.com/k2jCflI.png)

## `RIGHT JOIN` (Правое внешнее соединение)

Работает зеркально `LEFT JOIN`. Возвращает **все** строки из **правой** таблицы (указанной в `JOIN`) и совпадающие из левой. Если совпадения в левой таблице нет, для её столбцов будет `NULL`.

**Задача:** Вывести все отделы и, если возможно, сотрудников в них.

```sql
SELECT
    e.full_name,
    d.name
FROM
    employees AS e
RIGHT JOIN
    departments AS d ON e.department_id = d.id;
```

**Результат:**
| full_name       | name      |
|-----------------|-----------|
| Иван Петров     | IT        |
| Мария Козлова   | IT        |
| Анна Иванова    | HR        |
| **NULL**        | Marketing |

Теперь в результате есть все отделы, включая те, в которых нет сотрудников. На практике `RIGHT JOIN` используется редко, так как почти любой такой запрос можно переписать через `LEFT JOIN`, поменяв таблицы местами, что обычно проще для восприятия.

*Диаграмма Венна: все правое множество.*
![RIGHT JOIN](https://i.imgur.com/EE2Y21c.png)

## `FULL OUTER JOIN` (Полное внешнее соединение)

Объединяет `LEFT JOIN` и `RIGHT JOIN`. Возвращает **все** строки из **обеих** таблиц. Если для строки из одной таблицы нет совпадения в другой, недостающие значения заполняются `NULL`.

**Задача:** Вывести всех сотрудников и все отделы, сопоставив их там, где это возможно.

```sql
SELECT
    e.full_name,
    d.name
FROM
    employees AS e
FULL OUTER JOIN
    departments AS d ON e.department_id = d.id;
```

**Результат:**
| full_name       | name      |
|-----------------|-----------|
| Иван Петров     | IT        |
| Мария Козлова   | IT        |
| Анна Иванова    | HR        |
| Сергей Безруков | **NULL**  |
| **NULL**        | Marketing |

В результате присутствуют и сотрудник без отдела, и отдел без сотрудников.

*Диаграмма Венна: объединение двух множеств.*
![FULL OUTER JOIN](https://i.imgur.com/PznDoW4.png)

## Другие виды соединений

*   **`CROSS JOIN`**: Возвращает декартово произведение двух таблиц (каждая строка одной таблицы соединяется с каждой строкой другой). Используется редко.
*   **`NATURAL JOIN`**: `JOIN` по всем столбцам с одинаковыми именами. Считается плохой практикой, так как он неявный и может привести к ошибкам, если в таблицы добавятся новые столбцы с совпадающими именами.
*   **Self-join (Соединение таблицы с самой собой)**: Иногда нужно соединить таблицу саму с собой. Например, чтобы для каждого сотрудника найти имя его менеджера (который тоже является сотрудником). Это делается через присвоение таблице разных псевдонимов (`AS`). 