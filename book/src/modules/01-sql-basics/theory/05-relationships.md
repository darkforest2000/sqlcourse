# 9.5. Связи между таблицами

В реляционных базах данных информация разбита на множество таблиц. Чтобы эти данные имели смысл, таблицы должны быть связаны друг с другом. Механизм, обеспечивающий эти связи — это **первичные** и **внешние ключи**.

*   **Первичный ключ (Primary Key)**: Один или несколько столбцов, значения которых уникально идентифицируют каждую строку в таблице. Он не может содержать `NULL`.
*   **Внешний ключ (Foreign Key)**: Один или несколько столбцов в таблице, которые ссылаются на первичный ключ в другой таблице. Это и есть "связь".

## Типы связей

Существует три основных типа связей между таблицами.

### 1. Один-ко-многим (One-to-Many, 1:M)

Это самый распространенный тип связи. Одна запись в "родительской" таблице (таблица "один") может быть связана с несколькими записями в "дочерней" таблице (таблица "многие").

**Пример:** Один отдел — много сотрудников.
*   Таблица `departments` (отделы) — родительская. Её первичный ключ `id`.
*   Таблица `employees` (сотрудники) — дочерняя. В ней есть внешний ключ `department_id`, который ссылается на `departments(id)`.

**Реализация:**
```sql
CREATE TABLE departments (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL
);

CREATE TABLE employees (
    id SERIAL PRIMARY KEY,
    full_name VARCHAR(100) NOT NULL,
    department_id INTEGER, -- Внешний ключ

    -- Устанавливаем связь
    FOREIGN KEY (department_id) REFERENCES departments (id)
);
```
Теперь у каждого сотрудника может быть только один отдел, но в одном отделе может быть много сотрудников.

### 2. Многие-ко-многим (Many-to-Many, M:N)

Эта связь возникает, когда одна запись из таблицы А может быть связана с несколькими записями из таблицы Б, и наоборот.

**Пример:** Студенты и курсы. Один студент может записаться на много курсов, и на одном курсе может учиться много студентов.

Такую связь нельзя реализовать напрямую. Для этого используется третья, **связующая таблица** (junction table).

**Реализация:**
```sql
CREATE TABLE students (
    id SERIAL PRIMARY KEY,
    full_name VARCHAR(100) NOT NULL
);

CREATE TABLE courses (
    id SERIAL PRIMARY KEY,
    title VARCHAR(150) NOT NULL
);

-- Связующая таблица
CREATE TABLE student_courses (
    student_id INTEGER REFERENCES students(id),
    course_id INTEGER REFERENCES courses(id),
    enrollment_date DATE,
    
    -- Первичный ключ состоит из двух внешних ключей,
    -- чтобы пара (студент, курс) была уникальной.
    PRIMARY KEY (student_id, course_id)
);
```
В таблице `student_courses` каждая строка — это факт записи одного конкретного студента на один конкретный курс.

### 3. Один-к-одному (One-to-One, 1:1)

Это самый редкий тип связи. Одна запись в таблице А может быть связана только с одной записью в таблице Б, и наоборот.

Обычно такую связь используют, чтобы:
*   Разбить большую таблицу с множеством столбцов на части по логическому смыслу.
*   Вынести редко используемые данные в отдельную таблицу для оптимизации.
*   Реализовать более строгий контроль доступа к части данных.

**Пример:** Пользователи и их паспорта. У каждого пользователя может быть только один паспорт.

**Реализация:**
Ключевым моментом является добавление ограничения `UNIQUE` к внешнему ключу.

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) NOT NULL
);

CREATE TABLE passports (
    id SERIAL PRIMARY KEY,
    series VARCHAR(4) NOT NULL,
    number VARCHAR(6) NOT NULL,
    user_id INTEGER NOT NULL UNIQUE, -- Уникальность обеспечивает связь 1:1

    FOREIGN KEY (user_id) REFERENCES users(id)
);
```
Ограничение `UNIQUE` на `user_id` в таблице `passports` не позволит создать две записи с одним и тем же `user_id`, обеспечивая связь "один-к-одному".

## Целостность данных (Referential Integrity)

Внешние ключи также помогают поддерживать целостность данных. Что должно произойти с сотрудниками, если мы удалим их отдел?

Для этого при определении внешнего ключа можно указать правила:
*   `ON DELETE`: Что делать в дочерней таблице, если связанная строка удаляется из родительской.
*   `ON UPDATE`: Что делать, если значение первичного ключа в родительской таблице изменяется (редко, но возможно).

**Основные действия:**
*   `RESTRICT` (или `NO ACTION`): Запретить удаление/изменение в родительской таблице, если есть связанные строки. Это поведение по умолчанию.
*   `CASCADE`: Удалить/обновить связанные строки в дочерней таблице автоматически.
*   `SET NULL`: Установить значение внешнего ключа в `NULL` в дочерней таблице.
*   `SET DEFAULT`: Установить значение внешнего ключа в значение по умолчанию.

**Пример с `CASCADE`:**
```sql
-- При удалении отдела, все его сотрудники тоже будут удалены
FOREIGN KEY (department_id) REFERENCES departments (id) ON DELETE CASCADE;
```
Используйте `CASCADE` с большой осторожностью, так как это может привести к массовому удалению данных. 