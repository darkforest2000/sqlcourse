# 9.1. Устройство PostgreSQL

PostgreSQL — это мощная, свободно распространяемая объектно-реляционная система управления базами данных (СУБД). Её надёжность, гибкость и соответствие стандартам SQL сделали её популярным выбором для самых разных проектов, от небольших приложений до крупных систем с высокой нагрузкой.

## Архитектура "Клиент-Сервер"

PostgreSQL работает по классической клиент-серверной модели.

*   **Сервер (Backend)**: Это ядро СУБД. Процесс `postgres` (также известный как `postmaster`) постоянно запущен на сервере, где хранятся данные. Он прослушивает сетевые подключения от клиентов. Когда клиент подключается, `postmaster` создает для него отдельный дочерний процесс-обработчик. Этот процесс выполняет все запросы данного клиента, обеспечивая изоляцию сессий друг от друга.
*   **Клиент (Frontend)**: Это любое приложение, которое подключается к серверу для выполнения SQL-запросов. Это может быть консольная утилита (`psql`), графический интерфейс (pgAdmin, DBeaver) или ваше собственное приложение, использующее специальную библиотеку (драйвер) для подключения к PostgreSQL.

## Логическая структура хранения

Данные в PostgreSQL организованы иерархически:

1.  **Кластер баз данных (Database Cluster)**: Это совокупность баз данных, управляемая одним экземпляром сервера PostgreSQL. Физически это просто каталог на диске (обычно `/var/lib/pgsql/data` или аналогичный), содержащий все данные и конфигурационные файлы.
2.  **База данных (Database)**: Кластер может содержать несколько баз данных. Каждая БД — это изолированное пространство для хранения объектов. Пользователи из одной БД не могут напрямую видеть данные в другой (если не использовать специальные расширения типа `dblink`).
3.  **Схемы (Schemas)**: Внутри каждой базы данных можно создавать схемы. Схема — это пространство имен. Она позволяет логически группировать таблицы, функции и другие объекты. Это полезно для организации больших приложений или для разграничения прав доступа. Если схема не указана, используется схема по умолчанию — `public`.
4.  **Объекты базы данных**: Внутри схем находятся уже знакомые нам объекты:
    *   **Таблицы (Tables)**: Основные структуры для хранения данных.
    *   **Индексы (Indexes)**: Вспомогательные структуры для ускорения поиска данных.
    *   **Представления (Views)**: Виртуальные таблицы, основанные на результатах SQL-запроса.
    *   **Функции и хранимые процедуры**: Блоки кода, которые можно выполнять на сервере.
    *   **Последовательности (Sequences)**, **Типы данных** и другие.

## Процессная архитектура

Работающий сервер PostgreSQL — это несколько взаимодействующих процессов:

*   `postmaster`: Главный управляющий процесс. Он запускается первым и отвечает за запуск и остановку дочерних процессов, а также принимает входящие подключения.
*   **Рабочие процессы (Backend Processes)**: На каждое клиентское подключение `postmaster` создает отдельный процесс `postgres`. Он обрабатывает все запросы от этого клиента.
*   **Фоновые процессы (Background Processes)**:
    *   **Writer (BGWriter)**: Периодически записывает "грязные" (измененные в памяти) буферы на диск, снижая нагрузку на рабочие процессы.
    *   **WAL Writer (WAL Writer)**: Записывает транзакционный лог (Write-Ahead Log) на диск. Это ключевой механизм для обеспечения долговечности (Durability) и восстановления после сбоев.
    *   **Autovacuum Launcher**: Запускает процессы очистки (`autovacuum worker`), которые удаляют "мертвые" строки и анализируют таблицы для оптимизации запросов.
    *   **Checkpointer**: Обеспечивает, что все изменения данных рано или поздно попадут на диск, создавая "точки сохранения" (checkpoints).

## Транзакции и многоверсионность (MVCC)

Одной из ключевых особенностей PostgreSQL является реализация многоверсионного управления параллельным доступом (Multi-Version Concurrency Control, MVCC).

Вместо того чтобы блокировать данные при чтении, PostgreSQL для каждого запроса создает "снимок" (snapshot) данных на определенный момент времени. Когда транзакция изменяет строку, СУБД не перезаписывает старые данные, а создает новую версию этой строки. Старая версия остается видимой для транзакций, которые начались раньше. Это позволяет разным клиентам читать и писать данные одновременно с минимальными блокировками, что значительно повышает производительность в многопользовательских системах. 